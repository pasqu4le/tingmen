{# --------------------------- Widgets Macros -------------------------------- #}

{% macro flashed_messages_widget() -%}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            {{ render_message(message, category) }}
        {% endfor %}
    {% endwith %}
{%- endmacro %}

{% macro topics_widget(topics, more_topics_number, current_topic=None) -%}
<div class="panel panel-default">
    <div class="panel-heading">
        <p class="panel-title">Topics</p>
    </div>
    <div class="list-group">
        {% for topic in topics %}
            <a class="list-group-item{% if current_topic and topic == current_topic %} active{% endif %}" href="{{ topic.link_to() }}">#{{ topic.name }}</a>
        {% endfor %}
        <a class="list-group-item list-group-item-info" href="/topics/">More topics<span class="badge">{{ more_topics_number }}</span></a>
    </div>
</div>
{%- endmacro %}

{% macro security_widget(currently) -%}
<div class="panel panel-default">
    <div class="list-group">
        <a href="/register" class="list-group-item{% if currently == 'register' %} active{% endif %}">
            <p class="list-group-item-text">Not registered yet?</p>
            <h4 class="list-group-item-heading">Join us</h4>
        </a>
        <a href="/login" class="list-group-item{% if currently == 'login' %} active{% endif %}">
            <p class="list-group-item-text">Already registered?</p>
            <h4 class="list-group-item-heading">Log in</h4>
        </a>
        <a href="/reset" class="list-group-item{% if currently == 'reset' %} active{% endif %}">
            <p class="list-group-item-text">Forgot your password?</p>
            <h4 class="list-group-item-heading">Reset it!</h4>
        </a>
        <a href="/confirm" class="list-group-item{% if currently == 'confirm' %} active{% endif %}">
            <p class="list-group-item-text">Lost confirmation email?</p>
            <h4 class="list-group-item-heading">Send it again</h4>
        </a>
    </div>
</div>
{%- endmacro %}

{% macro pages_widget(pages, current_page=None) -%}
<div class="panel panel-default">
    <div class="panel-heading">
        <p class="panel-title">Read</p>
    </div>
    <div class="list-group">
        {% for page in pages %}
            <a class="list-group-item{% if current_page and page.name == current_page.name %} active{% endif %}" href="{{ page.link_to() }}">{{ page.name }}</a>
        {% endfor %}
    </div>
</div>
{%- endmacro %}

{% macro law_widget(statuses, groups, orders, current_status=None, current_group=None, current_order="id") -%}
<div class="btn-group btn-group-justified">
    <div class="btn-group">
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Group: {% if current_group %}{{ current_group.name }}{% else %}All{% endif %} <span class="caret"></span></button>
        <ul class="dropdown-menu">
            {% if current_group %}
                <li><a href="/laws/all/{{ current_status.name }}/{{ current_order }}/">All</a></li>
            {% endif %}
            {% for group in groups %}
                {% if (not current_group) or (current_group and current_group.name != group.name) %}
                    <li><a href="/laws/{{ group.name }}/{{ current_status.name }}/{{ current_order }}/">{{ group.name }}</a></li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Status: {{ current_status.name }} <span class="caret"></span></button>
        <ul class="dropdown-menu">
            {% for status in statuses %}
                {% if current_status and current_status.name != status.name %}
                    <li><a href="/laws/{% if current_group %}{{ current_group.name }}{% else %}all{% endif %}/{{ status.name }}/{{ current_order }}/">{{ status.name }}</a></li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Order by: {{ current_order }} <span class="caret"></span></button>
        <ul class="dropdown-menu">
            {% for order in orders %}
                {% if current_order and current_order != order %}
                    <li><a href="/laws/{% if current_group %}{{ current_group.name }}{% else %}all{% endif %}/{{ current_status.name }}/{{ order }}/">{{ order }}</a></li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>
</div>
{%- endmacro %}

{% macro proposal_widget(statuses, current_status=None) -%}
<div class="panel panel-default">
    <div class="panel-heading text-center">
        <p class="panel-title ">Status</p>
    </div>
    <div class="list-group">
        {% for status in statuses %}
            <a role="presentation" class="list-group-item{% if current_status and current_status == status %} active{% endif %}" href="/proposals/{{ status }}/">{{ status }}</a>
        {% endfor %}
    </div>
</div>
{%- endmacro %}

{% macro user_widget(main_subpage, subpages, user) -%}
<div class="panel panel-primary">
    <div class="panel-heading panel-title">
        <img class="img-rounded img-responsive center-block" src="{{ user.email | gravatar }}">
        <p class="text-center "> @{{ user.username }}</p>
    </div>
    <ul class="panel-body nav nav-pills nav-stacked">
        {% for subpage in subpages %}
            <li role="presentation" {% if main_subpage == subpage %}class="active"{% endif %}><a href="{{ user.link_to() }}/{{ subpage }}/">{{ subpage }}</a></li>
        {% endfor %}
    </ul>
</div>
{%- endmacro %}

{# --------------------------- Rendering Macros -------------------------------- #}


{% macro render_proposal(proposal, current_user, comment_here=False) -%}
<div id="proposal-{{ proposal.id }}">
    <div class="panel panel-default">
        <div class="panel-body">
            <div class="row">
                <p class="lead col-xs-7">
                    <a href="{{ proposal.link_to() }}">Proposal n. {{ proposal.id }}</a>, by <a href="{{ proposal.poster.link_to() }}">@{{ proposal.poster.username }}</a>
                </p>
                <div class="dropdown col-xs-5 text-right">
                    <a href="{{ proposal.link_to() }}" class="text-muted">{{ render_date(proposal.date) }}</a>
                    {% if current_user.is_authenticated %}
                        <a class="dropdown-toggle text-muted" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="glyphicon glyphicon-cog"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li id="proposal-{{ proposal.id }}-subscription">{{ render_subscription(current_user, proposal, 'proposal') }}</li>
                            {% if proposal.poster == current_user and proposal.is_pending %}
                                <li role="separator" class="divider"></li>
                                <li><a href="/edit/proposal/{{ proposal.id }}"><span class="glyphicon glyphicon-pencil"></span> Edit</a></li>
                            {% endif %}
                            {% if current_user.has_role('admin') %}
                                <li role="separator" class="divider"></li>
                                {% if not proposal.confirmed() %}
                                    <li><a href="javascript://" onclick="Sijax.request('confirm_proposal', ['{{ proposal.id}}']);">Confirm</a></li>
                                {% endif %}
                            {% endif %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            <div class="text-muted lead">{{ proposal.description|markdown }}</div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="well well-sm text-center lead strong">Laws this proposal will add:</div>
                    {% for law in proposal.add_laws %}
                        {{ render_law(law, current_user) }}
                    {% endfor %}
                </div>
                <div class="col-md-6">
                    <div class="well well-sm text-center lead strong">Laws this proposal will remove:</div>
                    {% for law in proposal.remove_laws %}
                        {{ render_law(law, current_user) }}
                    {% endfor %}
                </div>
            </div>
            {% if proposal.is_pending %}
                <div class="alert alert-info">This proposal is pending, will be voted on the {{ render_literal_date(proposal.vote_day) }}</div>
            {% endif %}
        </div>
        <div class="panel-footer btn-group btn-group-justified">
            <div class="btn-group">
                {% if current_user.is_authenticated and proposal.is_open %}
                    <div class="btn-group btn-group-justified">
                        <div class="btn-group">
                            <button class="btn btn-success" href="javascript://" onclick="Sijax.request('vote_proposal', ['{{ proposal.id}}', true]);">
                                <span class="glyphicon glyphicon-arrow-up"></span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <a class="btn btn-link disabled">
                                <strong class="{{ proposal.current_vote_style(current_user) }}" id="proposal_vote_{{ proposal.id }}">{{ proposal.points() }}</strong>
                            </a>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-danger" href="javascript://" onclick="Sijax.request('vote_proposal', ['{{ proposal.id}}', false]);">
                                <span class="glyphicon glyphicon-arrow-down"></span>
                            </button>
                        </div>
                    </div>
                {% else %}
                    <a class="btn btn-link disabled">
                        <span class="badge">{{ proposal.points() }}</span>
                        {% if proposal.approved() %}
                            <span class="label label-success">Approved</span>
                        {% elif proposal.rejected() %}
                            <span class="label label-danger">Rejected</span>
                        {% else %}
                            <span class="label label-default">Not voted</span>
                        {% endif %}
                    </a>
                {% endif %}
            </div>
            <div class="btn-group">
                <a class="btn btn-link" href="/new-proposal/change/{{ proposal.id }}/"><span class="glyphicon glyphicon-pencil"></span> change</a>
            </div>
            <div class="btn-group">
                {% if comment_here %}
                    <a class="btn btn-link collapser" data-autofill='{"destination":"#proposal-{{ proposal.id }}_form_space","topics":"#{{ proposal.topic.name }}"}'><span class="glyphicon glyphicon-share-alt"></span> comment <span class="badge">{{ proposal.topic.posts.count() }}</span></a>
                {% else %}
                    <a class="btn btn-link collapser" href="{{ proposal.link_to() }}"><span class="glyphicon glyphicon-share-alt"></span> comment <span class="badge">{{ proposal.topic.posts.count() }}</span></a>
                {% endif %}
            </div>
        </div>
    </div>
    <div id="proposal-{{ proposal.id }}_form_space"></div>
</div>
{%- endmacro %}

{% macro render_law(law, current_user, actions_footer=False, comment_here=False) -%}
<div class="law" id="law-{{ law.id }}">
    <div class="panel panel-info">
        <div class="panel-heading">
            <div class="row">
                <div class="col-xs-7"><a href="{{ law.link_to() }}" class="panel-title">Law n. {{ law.id }}</a>
                    <small> in {% for group in law.group %}<a href="/laws/{{group.name}}/active/id">{{group.name}}</a>{% if not loop.last %}, {% endif %}{% endfor %}</small>
                </div>
                <div class="dropdown col-xs-5 text-right">
                    {% for status in law.status %}<a href="/laws/all/{{status.name}}/id/" class="label label-success">{{status.name}}</a> {% endfor %}
                    {% if current_user.is_authenticated %}
                        <a class="dropdown-toggle text-muted" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="glyphicon glyphicon-cog"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li id="law-{{ law.id }}-subscription">{{ render_subscription(current_user, law, 'law') }}</li>
                            {% if law.add_by[-1].poster == current_user and law.add_by[-1].is_pending %}
                                <li role="separator" class="divider"></li>
                                <li><a href="/edit/law/{{ law.id }}"><span class="glyphicon glyphicon-pencil"></span> Edit</a></li>
                            {% endif %}
                            {% if current_user.has_role('admin') %}
                                <li role="separator" class="divider"></li>
                                <li><a href="javascript://" onclick="Sijax.request('set_law_active', ['{{ law.id}}']);">set active</a></li>
                                <li><a href="javascript://" onclick="Sijax.request('set_law_premature', ['{{ law.id}}']);">set premature</a></li>
                                <li><a href="javascript://" onclick="Sijax.request('set_law_impossible', ['{{ law.id}}']);">set impossible</a></li>
                            {% endif %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="panel-body">
            <div class="text-muted lead">{{ law.content|markdown }}</div>
        </div>
        {% if actions_footer %}
            <div class="panel-footer btn-group btn-group-justified">
                <a class="btn btn-link" href="{{ law.link_to() }}"><span class="glyphicon glyphicon-comment"></span> discussion <span class="badge">{{ law.topic.posts.count() }}</span></a>
                <a class="btn btn-link" href="/new-proposal/remove/{{ law.id }}/"><span class="glyphicon glyphicon-remove"></span> remove</a>
                {% if comment_here %}
                    <a class="btn btn-link collapser" data-autofill='{"destination":"#law-{{ law.id }}_form_space","topics":"#{{ law.topic.name }}"}'><span class="glyphicon glyphicon-share-alt"></span> comment</a>
                {% else %}
                    <a class="btn btn-link" href="{{ law.link_to() }}"><span class="glyphicon glyphicon-share-alt"></span> comment</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
    <div id="law-{{ law.id }}_form_space"></div>
</div>
{%- endmacro %}

{% macro render_post_group(posts, current_user, submit_post_form, new_post=False, load_more=False, posts_group=None, posts_name=None, topic=None) -%}
{{ render_collapsable_post_form(submit_post_form, current_user) }}
{% if new_post %}
    {{ new_post_panel(current_user, topic=topic) }}
{% endif %}
<div id="post-container">
    {% for post in posts %}
        {{ render_post(post, current_user) }}
    {% endfor %}
</div>
{% if posts and load_more %}
    <div id="load_more_container">
        {{ more_posts_panel(posts_group, posts_name, posts[-1].date) }}
    </div>
    {{ load_more_scripts() }}
{% endif %}
{%- endmacro %}

{% macro render_post(post, current_user) -%}
<div id="post-{{ post.id }}">
    <div class="panel panel-default">
        <div class="row panel-body">
            <div class="col-md-2 col-xs-3">
                <a href="{{ post.poster.link_to() }}"><img class="img-rounded img-responsive center-block" src="{{ post.poster.email | gravatar }}"></a>
                <p></p>
                {# render vote form #}
                <div class="btn-group-vertical btn-block">
                    {% if current_user.is_authenticated %}
                        <button class="btn btn-success btn-xs btn-block" href="javascript://" onclick="Sijax.request('vote_post', ['{{ post.id}}', true]);">
                            <span class="glyphicon glyphicon-thumbs-up"></span>
                        </button>
                        <a class="btn btn-default btn-block disabled">
                            <strong class="{{ post.current_vote_style(current_user) }}" id="post_vote_{{ post.id }}">{{ post.points()}}</strong>
                        </a>
                        <button class="btn btn-danger btn-xs btn-block" href="javascript://" onclick="Sijax.request('vote_post', ['{{ post.id}}', false]);">
                            <span class="glyphicon glyphicon-thumbs-down"></span>
                        </button>
                    {% else %}
                        <a class="btn btn-success btn-xs btn-block" href="/login">
                            <span class="glyphicon glyphicon-thumbs-up"></span>
                        </a>
                        <a class="btn btn-default btn-block disabled">
                            <strong>{{ post.points()}}</strong>
                        </a>
                        <a class="btn btn-danger btn-xs btn-block" href="/login">
                            <span class="glyphicon glyphicon-thumbs-down"></span>
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-10 col-xs-9">
                <div class="row">
                    <p class="lead text-info col-xs-5"><a href="{{ post.poster.link_to() }}"> –@{{ post.poster.username }}</a>{% if post.poster.roles %}<small> {% for role in post.poster.roles %}<span class="label label-primary">{{ role.name }}</span>{% endfor %}</small>{% endif%}</p>
                    <div class="dropdown col-xs-7 text-right">
                        <a href="{{ post.link_to() }}" class="text-muted">{{ render_date(post.date) }}</a>
                        {% if current_user.is_authenticated %}
                            <a class="dropdown-toggle text-muted" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="glyphicon glyphicon-cog"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-right">
                                <li id="post-{{ post.id }}-subscription">{{ render_subscription(current_user, post, 'post') }}</li>
                                {% if post.poster == current_user %}
                                    <li role="separator" class="divider"></li>
                                    <li><a href="/edit/post/{{ post.id }}"><span class="glyphicon glyphicon-pencil"></span> Edit</a></li>
                                    <li><a href="/delete/post/{{ post.id }}">
                                        <span class="glyphicon glyphicon-trash text-danger"></span>
                                        <span class="text-danger"> Delete</span>
                                    </a></li>
                                {% endif %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                <div class="text-muted lead">{{ post.content|markdown }}</div>
            </div>
        </div>
        <div class="panel-footer">
            <div class="row">
                <div class="pull-right">
                    <div class="btn-group">
                        <a class="btn btn-info" href="javascript://" onclick="Sijax.request('load_comments', ['{{ post.id }}', 1]);" id="load_comment_button_{{ post.id }}">
                            <span class="badge">{{ post.children | count }}</span> <span class="hidden-xs hidden-sm">comments </span><span class="glyphicon glyphicon-comment"></span>
                        </a>
                        <button class="collapser btn btn-primary" data-autofill='{"destination":"#post-{{ post.id }}-form","id":{{ post.id }},"topics":"{% for topic in post.topics %}#{{topic.name}} {% endfor %}"}'><span class="glyphicon glyphicon-share-alt"></span> reply</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="post-{{ post.id }}-form"></div>
    <div class="post-comments comment_dep_1" id="post-{{ post.id }}-comments"></div>
</div>
{%- endmacro %}

{% macro render_comment(post, current_user, depth=0) -%}
<div id="post-{{ post.id }}">
    <div class="panel panel-default">
        <div class="row panel-body">
            <div class="col-md-2 col-xs-3">
                <a href="{{ post.poster.link_to() }}"><img class="img-rounded img-responsive center-block" src="{{ post.poster.email | gravatar }}"></a>
            </div>
            <div class="col-md-10 col-xs-9">
                <p class="text-info"><a href="{{ post.poster.link_to() }}"> –@{{ post.poster.username }}</a>{% if post.poster.roles %}<small> {% for role in post.poster.roles %}<span class="label label-primary">{{ role.name }}</span>{% endfor %}</small>{% endif%}</p>
                <div class="text-muted lead">{{ post.content|markdown }}</div>
                <hr>
                <div class="btn-group btn-group-justified">
                    <div class="btn-group dropdown">
                        {% if current_user.is_authenticated %}
                            <a class="dropdown-toggle text-muted" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="glyphicon glyphicon-cog"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li id="post-{{ post.id }}-subscription">{{ render_subscription(current_user, post, 'post') }}</li>
                                {% if post.poster == current_user %}
                                    <li role="separator" class="divider"></li>
                                    <li><a href="/edit/post/{{ post.id }}"><span class="glyphicon glyphicon-pencil"></span> Edit</a></li>
                                {% endif %}
                            </ul>
                        {% endif %}
                        <a href="{{ post.link_to() }}" class="text-muted">{{ render_date(post.date) }}</a>
                    </div>
                    {# render vote form #}
                    <div class="btn-group text-center">
                        {% if current_user.is_authenticated %}
                            <a href="javascript://" onclick="Sijax.request('vote_post', ['{{ post.id}}', true]);">
                                <span class="glyphicon glyphicon-thumbs-up"></span>
                            </a>
                            •
                            <a class="disabled">
                                <strong class="{{ post.current_vote_style(current_user) }}" id="post_vote_{{ post.id }}">{{ post.points()}}</strong>
                            </a>
                            •
                            <a href="javascript://" onclick="Sijax.request('vote_post', ['{{ post.id}}', false]);">
                                <span class="glyphicon glyphicon-thumbs-down"></span>
                            </a>
                        {% else %}
                            <a href="/login">
                                <span class="glyphicon glyphicon-thumbs-up"></span>
                            </a>
                            •
                            <a class="disabled">
                                <strong>{{ post.points()}}</strong>
                            </a>
                            •
                            <a href="/login">
                                <span class="glyphicon glyphicon-thumbs-down"></span>
                            </a>
                        {% endif %}
                    </div>
                    <div class="btn-group">
                        <a class="btn btn-link" href="javascript://" onclick="Sijax.request('load_comments', ['{{ post.id }}', {{ depth + 1 }}]);" id="load_comment_button_{{ post.id }}">
                            <span class="badge">{{ post.children | count }}</span> <span class="glyphicon glyphicon-comment"></span>
                        </a>
                    </div>
                    <div class="btn-group text-right">
                        <a class="btn btn-link collapser" href="javascript://" data-autofill='{"destination":"#post-{{ post.id }}-form","id":{{ post.id }},"topics":"{% for topic in post.topics %}#{{topic.name}} {% endfor %}"}'><span class="glyphicon glyphicon-share-alt"></span> reply</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="post-{{ post.id }}-form"></div>
    <div class="post-comments comment_dep_{{ depth + 1 }}" id="post-{{ post.id }}-comments"></div>
</div>
{%- endmacro %}

{% macro render_autolink(link, title, icon) -%}
    <a href="{{ link }}">
        <div class="panel panel-default">
            <div class="panel-body">
                <h3><strong class="text-info">{{ title }}</strong></h3>
            </div>
            <div class="panel-footer">
                <div class="pull-left">
                    {% if icon %}
                        <img src="{{ icon }}" class="autolink-icon img-responsive" />
                    {% else %}
                        <span class="glyphicon glyphicon-link small"></span>
                    {% endif %}
                </div>
                <div class="autolink-url">{{ link }}</div>
            </div>
        </div>
    </a>
{%- endmacro %}

{% macro render_message(message, category) -%}
    <div class="alert alert-dismissible alert-{% if not category or category=='message' %}info{% else %}{{ category }}{% endif %}">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <p>{{ message }}</p>
    </div>
{%- endmacro %}

{% macro render_notifications_dropdown(current_user) -%}
    {% for notification in current_user.get_latest_notifications() %}
        {{ render_notification_navbar(notification) }}
    {% endfor %}
    {% if current_user.has_unseen_notifications() %}
        <li class="dropdown-header text-right"><a class="" href="javascript://" onclick="Sijax.request('set_all_notifications_seen');">mark all as seen</a></li>
    {% endif %}
    <li role="separator" class="divider"></li>
    <li><a href="/notifications/" class="text-center">See All</a></li>
{%- endmacro %}

{% macro render_notification_navbar(notification) -%}
    <li class="{% if not notification.seen %} notif-unseen-back{% endif %}" data-date="'{{ notification.date }}'">
        <a href="{{notification.link_to()}}">
            <img class="notif-img img-rounded" src="{{ notification.authors[-1].email | gravatar }}">  {{ notification.to_text() }}
        </a>
    </li>
{%- endmacro %}

{% macro render_notification(notification) -%}
    <li class="list-group-item{% if not notification.seen %} notif-unseen-back{% endif %}">
        <a href="{{notification.link_to()}}" class="lead">
            <img class="notif-img img-rounded" src="{{ notification.authors[-1].email | gravatar }}">  {{ notification.to_text() }}
        </a>
    </li>
{%- endmacro %}

{% macro render_subscription(current_user, item, item_type) -%}
    <a href="javascript://" onclick="Sijax.request('toggle_subscription', ['{{ item_type }}', {{ item.id }}]);">
        {% if current_user in item.subscribed %}
            <span class="glyphicon glyphicon-remove-circle"></span> Unsubscribe
        {% else %}
            <span class="glyphicon glyphicon-ok-circle"></span> Subscribe
        {% endif %}
    </a>
{%- endmacro %}

{% macro render_date(date) -%}
    {{ date.year }}-{{ date.month }}-{{ date.day }}<span class="hidden-xs hidden-sm"> {{ date.hour }}:{{ date.minute }}</span>
{%- endmacro %}

{% macro render_literal_date(date) -%}
    {{ date.day }}{% if date.day == 1 %}st{% elif date.day == 2 %}nd{% elif date.day == 3 %}rd{%else%}th{% endif %} {{ date.strftime("%B") }} {{ date.year }}
{%- endmacro %}

{% macro render_field(field, label_visible=false) -%}
<div class="form-group{% if field.errors %} has-error has-feedback{% endif %} {{ kwargs.pop('class_', '') }}">
    {{ field(class_='form-control', **kwargs) }}{% if field.type != 'HiddenField' and label_visible %} {{ field.label }}{% endif %}
    {% if field.errors %}
        <span class="glyphicon glyphicon-remove form-control-feedback" aria-hidden="true"></span>
        {% for e in field.errors %}
            <p class="help-block">{{ e }}</p>
        {% endfor %}
    {% endif %}
</div>
{%- endmacro %}

{% macro more_proposals_panel(older_than, open=False, pending=False) -%}
{#-----     this needs to be contained in a div with id load_more_container to work     -----#}
{% if older_than %}
    <div class="alert alert-info text-center lead" data-loader="load_more_proposals" data-load='[{% if open %}true{% else %}false{% endif %}, {% if pending %}true{% else %}false{% endif %}, "{{ older_than }}"]'></div>
{% else %}
    <div class="alert alert-info text-center lead">There are no more proposals here</div>
{% endif %}
{%- endmacro %}

{% macro more_laws_panel(group_name=None, status_name=None, order='id', last=None) -%}
{#-----     this needs to be contained in a div with id load_more_container to work     -----#}
{% if last %}
    <div class="alert alert-info text-center lead" data-loader="load_more_laws" data-load='[{% if group_name %}"{{ group_name }}"{% else %}null{% endif %}, {% if status_name %}"{{ status_name }}"{% else %}null{% endif %}, "{{ order }}", "{{ last }}"]'></div>
{% else %}
    <div class="alert alert-info text-center lead">There are no more laws here</div>
{% endif %}
{%- endmacro %}

{% macro more_posts_panel(group, name, older_than) -%}
{#-----     this needs to be contained in a div with id load_more_container to work     -----#}
{% if older_than %}
    <div class="alert alert-info text-center lead" data-loader="load_more_posts" data-load='[{% if group %}"{{ group }}"{% else %}null{% endif %}, {% if name %}"{{ name }}"{% else %}null{% endif %}, "{{ older_than }}"]'></div>
{% else %}
    <div class="alert alert-info text-center lead">There are no more posts here</div>
{% endif %}
{%- endmacro %}

{% macro more_notifications_panel(older_than) -%}
{#-----     this needs to be contained in a div with id load_more_container to work     -----#}
{% if older_than %}
    <div class="alert alert-info text-center lead" data-loader="load_more_notifications" data-load='["{{ older_than }}"]'></div>
{% else %}
    <div class="alert alert-info text-center lead">There are no more notifications</div>
{% endif %}
{%- endmacro %}

{% macro load_more_scripts() -%}
    {# --- needs to be rendered after the #load_more_container div to work --- #}
    <script type="text/javascript" src="/static/js/jquery.waypoints.min.js"></script>
    <script type="text/javascript">
    var waypoint = $('#load_more_container').waypoint({
        handler: function(direction) {
            if (direction == 'down'){
                this.disable();
                child = $('#load_more_container').children().last();
                loader = child.data('loader');
                load = child.data('load');
                if (load != null){
                    child.html('Loading ...');
                    Sijax.request(loader, load);
                }
            }
        },
        offset: 'bottom-in-view'
    })
    </script>
{%- endmacro %}

{% macro notifications_script(current_user) -%}
    {% if current_user.is_authenticated %}
        <script>
            setInterval(function(){
                first_child = $('#notifications_dropdown').children().first();
                if (first_child != null){
                    newer_than = first_child.data('date');
                } else {
                    newer_than = null;
                }
                Sijax.request('update_notifications', [newer_than]);
            }, 10000);
        </script>
    {% endif %}
{%- endmacro %}


{# --------------------------- Macros for the collapsable post form -------------------------------- #}

{% macro post_form_scripts(current_user, topics_all) -%}
{% if current_user.is_authenticated %}
    <link href="/static/css/sew.css" rel="stylesheet" media="screen">
    <script type="text/javascript" src="https://code.jquery.com/jquery-migrate-1.4.1.js"></script>
    <script type="text/javascript" src="/static/js/jquery.caretposition.js"></script>
    <script type="text/javascript" src="/static/js/jquery.sew.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            var customItemTemplate = "<div><span />&nbsp;<small /></div>";

            function elementFactory(element, e, token) {
                var template = $(customItemTemplate).find('span').text(token + e.val).end();
				element.append(template);
			};

            $("#content").sew({
                elementFactory: elementFactory,
                token: ["@", "#"],
                onFilterChanged: function(sew, expression, token) {
                    if (token == "@" && expression.length > 0) {
                        $.ajax({
                            url: "/api/users/search/" + encodeURIComponent(expression),
                            type: "GET",
                            success: function(result) {
                                var newValues = [];
                                for (var i = 0; i < Math.min(10, result.users.length); i++) {
                                    var user = result.users[i];
                                    newValues.push({
                                        val: user.username
                                    })
                                }
                                sew.setValues(newValues);
                            }
                        });
                    } else if (token == "#" && expression.length > 0) {
                        $.ajax({
                            url: "/api/topics/search/" + encodeURIComponent(expression),
                            type: "GET",
                            success: function(result) {
                                var newValues = [];
                                for (var i = 0; i < Math.min(10, result.topics.length); i++) {
                                    var topic = result.topics[i];
                                    newValues.push({
                                        val: topic.name
                                    })
                                }
                                sew.setValues(newValues);
                            }
                        });
                    }
                }
            })
        });
    </script>
{% endif %}
<script type="text/javascript" src="/static/js/post_forms.js"></script>
<script type="text/javascript" src="/static/js/hide_comments.js"></script>
{%- endmacro %}

{% macro new_post_panel(current_user, topic=None) -%}
{% if current_user.is_authenticated %}
    <div class="panel panel-default">
        <div class="panel-body">
            <h4 class="pull-left">Hey there {{ current_user.username }}, do you have something to share?</h4>
            <button type="button" class="collapser btn btn-primary btn-lg pull-right" data-autofill='{"destination":"#panel_form_space"{% if topic %},"topics":"#{{ topic.name }}"{% endif %}}'>Make a post!</button>
        </div>
        <div id="panel_form_space"></div>
    </div>
{% endif %}
{%- endmacro %}

{% macro render_collapsable_post_form(submit_post_form, current_user) -%}
<div class="collapse" id="collapsable_post_form">
    {{ render_post_form(submit_post_form, current_user) }}
</div>
{%- endmacro %}

{% macro render_post_form(submit_post_form, current_user) -%}
{% if current_user.is_authenticated %}
    <form class="well form" enctype="multipart/form-data" method="POST" name="post_form" id="post_form">
        {{ submit_post_form.hidden_tag() }}
        <div class="row">
            <div class="col-md-2 col-xs-3">
                <img class="img-rounded img-responsive center-block" src="{{ current_user.email | gravatar }}">
            </div>
            <div class="col-md-10 col-xs-9">
                {{ render_field(submit_post_form.content) }}
            </div>
        </div>
        <div class="row">
            <div class="pull-right">
                {{ render_field(submit_post_form.submit) }}
            </div>
        </div>
    </form>
{% else %}
    <div class="alert alert-warning">
        <h4 class="strong">You need to be logged in to post something! <a class="btn btn-primary" href="/login">Login</a></h4>
    </div>
{% endif %}
{%- endmacro %}

{# --------------------------- Macros for the proposal form -------------------------------- #}

{% macro proposal_form_scripts() -%}
    {{ law_form_scripts() }}
    <script type="text/javascript" src="/static/js/proposal_forms.js"></script>
{%- endmacro %}

{% macro render_proposal_form(proposal_form, current_user, editing=False) -%}
<form class="panel panel-default form" {% if not editing %}action="/new-proposal/"{% endif %} enctype="multipart/form-data" method="POST" name="proposal_form" id="proposal_form">
    {{ proposal_form.hidden_tag() }}
    <div class="panel-body">
        <div class="text-center">
            {% if not editing %}
                <strong class="h2">New Proposal</strong>
            {% endif %}
            {{ render_field(proposal_form.description) }}
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <div class="well well-sm text-center lead strong">Laws this proposal will add:</div>
                <div id="new-law-form-container">
                    {% for law_form in proposal_form.new_laws %}
                        {# single law-form render #}
                        <div class="well">
                            {{ law_form.hidden_tag() }}
                            <div class="row">
                                <strong class="col-xs-4">Law in:</strong>
                                <div class="col-xs-8">
                                    {{ render_field(law_form.groups) }}
                                </div>
                            </div>
                            {{ render_field(law_form.content) }}
                        </div>
                    {% endfor %}
                </div>
                <div class="text-center">
                    <a class="btn btn-success" id="add_law_form">Add another law</a>
                </div>
                <p></p>
            </div>
            <div class="col-md-6">
                <div class="well well-sm text-center lead strong">Laws this proposal will remove:</div>
                <div id="remove-law-container">
                    {% for remove_field in proposal_form.remove_laws %}
                        <div class="well">
                            <div class="row">
                                <strong class="col-xs-3">Law n°</strong>
                                <div class="col-xs-9">
                                    {{ render_field(remove_field) }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="text-center">
                    <a class="btn btn-danger" id="remove_law">Remove another law</a>
                </div>
            </div>
        </div>
    </div>
    <div class="panel-footer">
        {{ render_field(proposal_form.submit) }}
    </div>
</form>
{%- endmacro %}

{% macro law_form_scripts() -%}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.6/select2-bootstrap.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $(".group_form").select2();
        });
    </script>
{%- endmacro %}

{% macro render_law_form(law_form) -%}
<form class="well form" enctype="multipart/form-data" method="POST" name="law_form" id="law_form">
    {{ law_form.hidden_tag() }}
    <div class="row">
        <strong class="col-xs-4">Law in:</strong>
        <div class="col-xs-8">
            {{ render_field(law_form.groups) }}
        </div>
    </div>
    {{ render_field(law_form.content) }}
    {{ render_field(law_form.submit) }}
</form>
{%- endmacro %}
